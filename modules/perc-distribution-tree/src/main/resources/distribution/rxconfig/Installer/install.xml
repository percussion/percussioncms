<?xml version="1.0"?>
<project name="Percussion Install" default="install">

    <tstamp>
        <format property="timestamp" pattern="yyyy-MM-dd_HH-mm-ss"/>
    </tstamp>

    <property environment="env"/>
    <property name="port" value="9994"/>
    <property name="https.port" value="8443"/>
    <property name="install.type" value="new"/>
    <property name="install.src" location="../.."/>
    <property name="install.dir" location="${install.src}"/>
    <property name="install.dir_parent" location="${install.dir}/.."/>
    <property name="jetty.base" location="${install.dir}/jetty/base"/>
    <property name="derby.db.path" location="${install.dir}/Repository"/>
    <property name="installation.properties" location="${jetty.base}/etc/installation.properties"/>
    <property name="install.configdir.src" location="${install.src}/rxconfig/Installer"/>
    <property name="install.configdir" location="${install.dir}/rxconfig/Installer"/>
    <property name="rxrepository.properties.new" location="${install.configdir.src}/rxrepository.properties"/>
    <property name="rxrepository.properties" location="${install.dir}/rxconfig/Installer/rxrepository.properties"/>
    <basename property="destination_folder_name" file="${install.dir}"/>
    <property name="backup_folder" location="${install.dir_parent}/${destination_folder_name}_${timestamp}"/>
    <property name="customer.jdbc.drivers" value="${install.dir}/jetty/base/lib/jdbc"/>
    <property name="ds.name" value="RhythmyxData"/>
    <property name="version" value="1_0_0"/>
    <property name="clean.install" value="false"/>
    <property name="install.dts" value="false"/>
    <property name="install.stage.dts" value="false"/>
    <property name="install.server" value="true"/>
    <property name="backup" value="false"/>
    <property name="build.log.dir" location="${install.configdir}/install_logs"/>
    <property name="extensions.jar.path" location="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/lib"/>
    <property name="perc.version" value="${env.percversion}" />
    <property name="jetty.present" value="false"/>
    <dirname property="install.src" file="${ant.file}"/>

    <condition property="isMac">
        <os family="mac" />
    </condition>
    <condition property="isWindows">
        <os family="windows" />
    </condition>
    <condition property="isLinux">
        <and>
            <not>
                <os family="mac"/>
            </not>
            <os family="unix" />
        </and>
    </condition>

    <condition property="installSameSrcDest" value="true" else="false">
        <equals arg1="${install.dir}" arg2="${install.src}"/>
    </condition>

    <condition property="do.install" value="true" else="false">
        <and>
            <not>
                <equals arg1="${install.dir}" arg2="${install.src}"/>
            </not>
            <or>
                <not>
                    <available file="${install.dir}/ObjectStore" type="dir"/>
                </not>
                <equals arg1="${clean.install}" arg2="true"/>
            </or>
        </and>
    </condition>

    <condition property="do.upgrade" value="true" else="false">
        <and>
            <not>
                <equals arg1="${install.dir}" arg2="${install.src}"/>
            </not>
            <not><equals arg1="true" arg2="${do.install}"/></not>
        </and>
    </condition>

    <condition property="do.backup" value="true" else="false">
        <and>
            <available file="${install.dir}" type="dir"/>

            <equals arg1="${backup}" arg2="true"/>

        </and>
    </condition>

    <condition property="upgradeFrom732" value="true" else="false">
        <and>
            <available file="${install.dir}/Version.properties"/>
            <resourcecontains resource="${install.dir}/Version.properties" substring="displayVersion=7.3.2" />
        </and>
    </condition>
    <echo>upgradeFrom732=${upgradeFrom732}</echo>
    <echo>development install=${DEVELOPMENT}</echo>
    <echo>clean.install=${clean.install}</echo>
    <echo>base.dir=${base.dir}</echo>
    <echo>install.src=${install.src}</echo>
    <echo>install.dir= ${install.dir}</echo>
    <echo>upgrade=${do.upgrade}</echo>
    <echo>install=${do.install}</echo>
    <echo>Copying JDBC Jars...</echo>
    <mkdir dir="${install.dir}/jetty/base/lib/jdbc" />
    <copy todir="${install.dir}/jetty/base/lib/jdbc" overwrite="true" force="true">
        <fileset dir="${install.src}/jetty/base/lib/jdbc">
            <include name="**/*.jar"/>
        </fileset>
    </copy>

    <path id="ant.deps" cache="true">
        <fileset dir="${install.dir}/jetty/base/lib/jdbc">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${install.src}/jetty/base/lib/jdbc">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${customer.jdbc.drivers}"  erroronmissingdir="false">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${install.src}/jetty/defaults/lib/perc" erroronmissingdir="false">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${install.src}/jetty/defaults/lib/perc-logging" erroronmissingdir="false">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <classloader classpathref="ant.deps" parentfirst="false" name="ant.loader.ant.deps"/>

    <taskdef resource="com/percussion/ant/antlib.xml" classpathref="ant.deps" loaderref="ant.loader.ant.deps" />

    <taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="ant.deps" loaderref="ant.loader.ant.deps" />

    <echo>Checking jetty directory exists...</echo>

    <!-- Flagging Pages & Assets for startup processing -->
    <!-- This always needs run on upgrade to 8.0.3 -->
    <echo>Flagging Assets and Pages for startup processing...</echo>
    <delete file="${install.dir}/upgrade/processedlinks/Assets.json" failonerror="false"/>
    <delete file="${install.dir}/upgrade/processedlinks/Pages.json" failonerror="false"/>


    <!-- Delete json files here end-->

    <property name="customer.jdbc.drivers" location="${install.dir}/jetty/base/lib/jdbc" />
    <mkdir dir="${customer.jdbc.drivers}"/>
    <echo>Checking for existing JDBC Drivers...</echo>
    <copy verbose="true" todir="${install.dir}/jetty/base/lib/jdbc" preservelastmodified="true" filtering="false" overwrite="false" force="false" failonerror="false">
        <fileset dir="${install.dir}/AppServer/server/rx/deploy/rxapp.ear/rxapp.war/WEB-INF/lib">
            <include name="mysql*.jar"/>
        </fileset>
        <fileset dir="${install.dir}/AppServer/server/rx/lib">
            <include name="mysql*.jar"/>
        </fileset>
    </copy>

       <copy verbose="true" todir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user" preservelastmodified="true" filtering="false" overwrite="false" force="false" failonerror="false">
        <fileset dir="${install.dir}/AppServer/server/rx/deploy/rxapp.ear/rxapp.war/WEB-INF/config/user">
        </fileset>
    </copy>

    <target name="setup-logging">
        <mkdir dir="${install.dir}/rxconfig/Installer"/>
        <touch file="${install.dir}/rxconfig/Installer/install.log" />
        <record name="${install.dir}/rxconfig/Installer/install.log"
                loglevel="verbose"/>
        <echo message="Build logged to ${install.dir}/rxconfig/Installer/install.log"/>
    </target>

    <target name="init" depends="setup-logging">
        <fail message="Property &quot;install.dir&quot; needs to be set">
            <condition>
                <istrue value="${installSameSrcDest}"/>
            </condition>
        </fail>
    </target>

    <target name="install_properties">
        <loadproperties srcFile="${installation.properties}"/>
        <property name="jetty.http.port" value="9992"/>
        <property name="jetty.ssl.port" value="8443"/>
        <property name="jetty.sslContext.keyStorePath" value=""/>
        <property name="jetty.sslContext.keyStorePassword" value=""/>
        <property name="jetty.sslContext.trustStorePath" value=""/>
        <property name="jetty.sslContext.keyManagerPassword" value=""/>
        <property name="jetty.sslContext.trustStorePassword" value=""/>
        <property name="perc.ssl.protocols" value=""/>
        <echoproperties/>
        <propertyfile file="${installation.properties}">
            <entry key="jetty.http.port" value="${port}" default="${jetty.http.port}"/>
            <entry key="jetty.ssl.port" value="${https.port}" default="${jetty.ssl.port}"/>
            <entry key="jetty.sslContext.keyStorePath" value="" default=""/>
            <entry key="jetty.sslContext.keyStorePassword" value="" default=""/>
            <entry key="jetty.sslContext.trustStorePath" value="" default=""/>
            <entry key="jetty.sslContext.keyManagerPassword" value="" default=""/>
            <entry key="jetty.sslContext.trustStorePassword" value="" default=""/>
            <entry key="perc.ssl.protocols" value="" default=""/>
        </propertyfile>
    </target>

    <target name="setupDB">
        <echo>Setting up Database</echo>
        <ant antfile="installRepository.xml" inheritRefs="true"/>
    </target>

    <target name="configure_jetty">

        <!-- Add legacy encryption key -->
        <echo>Copying legacy decryption key...</echo>
        <mkdir dir="${install.dir}/rxconfig/secure/" />
        <copy todir="${install.dir}/rxconfig/secure/"
              failonerror="true" overwrite="true" verbose="true">
            <fileset dir="${install.src}/rxconfig/secure/" defaultexcludes="no">
                <include name=".legacy-key"/>
            </fileset>
        </copy>

        <mkdir dir="${install.dir}/rxconfig/esapi"/>
        <copy todir="${install.dir}/rxconfig/esapi/"
              failonerror="true" overwrite="false" verbose="true">
            <fileset dir="${install.src}/rxconfig/esapi/" defaultexcludes="no">
                <include name="**/*"/>
            </fileset>
        </copy>

        <echo>Configuring Datasource...</echo>

        <if>
            <!-- don't try to migrate configuration if it has already been done -->
            <available file="${install.dir}/AppServer/server/rx/deploy/jboss-web.deployer/server.xml" />
        <then>
            <PSUpdateJettyConfigFromJBoss rootDir="${install.dir}"/>
            <PSConfigurePort rootDir="${install.dir}"/>
        </then>
        </if>

        <echo>Updating CMS Config Files ************************...</echo>

        <if>
            <not>
                <available file="${install.dir}/rxconfig/DeliveryServer" type="dir"/>
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/DeliveryServer" />
                <copy todir="${install.dir}/rxconfig/DeliveryServer" file="${install.src}/rxconfig/DeliveryServer/delivery-servers.xml"  failonerror="true" overwrite="false" verbose="true" />
            </then>
        </if>


        <if>
            <not>
                <available file="${install.dir}/rxconfig/LDAP" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/LDAP" />
                <copy todir="${install.dir}/rxconfig/LDAP" file="${install.src}/rxconfig/LDAP/ldapserver.xml"  failonerror="true" overwrite="false" verbose="true" />
            </then>
        </if>


        <if>
            <not>
                <available file="${install.dir}/rxconfig/Widgets" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Widgets" />
                <copy todir="${install.dir}/rxconfig/Widgets/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Widgets/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>


        <if>
            <not>
                <available file="${install.dir}/rxconfig/Categories" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Categories" />
                <copy todir="${install.dir}/rxconfig/Categories/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Categories/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>



        <if>
            <not>
                <available file="${install.dir}/rxconfig/Proxy" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Proxy" />
                <copy todir="${install.dir}/rxconfig/Proxy/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Proxy/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>



        <if>
            <not>
                <available file="${install.dir}/rxconfig/Plugins" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Plugins" />
                <copy todir="${install.dir}/rxconfig/Plugins/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Proxy/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>

        <if>
            <not>
                <available file="${install.dir}/rxconfig/Server/ContentEditors" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Server/ContentEditors" />
                <copy todir="${install.dir}/rxconfig/Server/ContentEditors/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Server/ContentEditors/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>


        <if>
            <not>
                <available file="${install.dir}/rxconfig/Data" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/Data" />
                <copy todir="${install.dir}/rxconfig/Data/"
                      failonerror="false" overwrite="false" verbose="true">
                    <fileset dir="${install.src}/rxconfig/Data/" defaultexcludes="no">
                        <include name="**/*"/>
                    </fileset>
                </copy>
            </then>
        </if>

        <if>
            <not>
                <available file="${install.dir}/rxconfig/SiteConfigs" type="dir" />
            </not>
            <then>
                <mkdir dir="${install.dir}/rxconfig/SiteConfigs" />
            </then>
        </if>

        <if>
            <not>
                <available file="${install.dir}/rxconfig/tika-config.xml" type="file" />
            </not>
            <then>
                <copy todir="${install.dir}/rxconfig/" file="${install.src}/rxconfig/tika-config.xml"  failonerror="true" overwrite="false" verbose="true" />
            </then>
        </if>


    </target>

    <!-- Text files to fix up line endings -->
    <patternset id="text.files">
        <include name="**/*.txt"/>
        <include name="**/*.sh"/>
        <include name="**/*.bat"/>
        <include name="**/*.xml"/>
        <include name="**/*.xsl"/>
        <include name="**/*.md"/>
    </patternset>

    <!-- Executable files that require setting execute permission on linux -->
    <patternset id="executable.files">
        <include name="**/*.sh"/>
        <include name="**/*.bin"/>
    </patternset>

    <patternset id="customer.data">
        <exclude name="**/*.sh"/>
    </patternset>

    <!-- Add files here that are runtime files that can be cleaned up freely-->
    <patternset id="cache.file.excludes">
        <exclude name="dbg_*.xml"/>
        <exclude name=".sys*/**"/>
        <exclude name="*-config.jar"/>
        <!-- common OS detritus -->
        <exclude name="**/.DS_Store"/>
        <exclude name="**/Thumbs.db"/>
        <exclude name="**/desktop.ini"/>
        <!-- common temp files -->
        <exclude name="**/*~"/>
        <exclude name="**/*.bak"/>
        <exclude name="**/*.backup"/>
        <exclude name="**/*.old"/>
        <exclude name="**/*.swp"/>
        <exclude name="**/*.debug"/>
        <exclude name="**/*.dump"/>
        <exclude name="**/*.log"/>
        <exclude name="**/~*"/>
        <!-- common git/scm files -->
        <exclude name="**/*.orig"/>
        <exclude name="**/*.diff"/>
        <exclude name="**/*.patch"/>
        <exclude name="**/.gitignore"/>
        <!-- various editor files -->
        <exclude name="**/*.iml"/>
        <exclude name="**/*.ipr"/>
        <exclude name="**/*.iws"/>
        <exclude name="**/*.idea"/>
        <exclude name="**/.classpath"/>
        <exclude name="**/.project"/>
        <!-- maven dust -->
        <exclude name="**/*.versionsBackup"/>
        <exclude name="**/*.releaseBackup"/>

    </patternset>


    <!-- Deletes includes folders that should be fully replaced by install -->

    <patternset id="upgrade.replace.folders">
        <include name="Administration/**"/>
        <include name="InlineLinkConverter/**"/>
        <include name="cm/**"/>
        <include name="Docs/**"/>
        <include name="Exits/**"/>
        <include name="ManagedNavExits/**"/>
        <include name="SiteFolderPublishinExits/**"/>
        <include name="WorkflowExits/**"/>
        <include name="Packages/Percussion/**"/>
        <include name="jetty/upstream/**"/>
        <include name="jetty/defaults/**"/>
        <include name="rxconfig/Server/requestHandlers/publisherhandler.xml"/>
        <include name="logs/**"/>
        <include name="rxconfig/Installer/data/**"/>
        <include name="web_resources/cm/**"/>
    </patternset>

    <patternset id="upgrade.delete">
        <include name="jetty/base/lib/extra/PSOToolkit*.jar"/>
        <include name="jetty/base/webapps/Rhythmyx/**" />
        <include name="Repository/derby.properties" />
        <include name="cm/**"/>
        <include name="jdbc/**"/>
        <include name="dbg_*.xml"/>
        <include name=".sys*/**"/>
        <include name="InstallableApps/**"/>
        <include name="rxconfig/Server/requestHandlers/publisherhandler.xml"/>
        <include name="Delivery/**"/>
        <include name="StartServer.*"/>
        <include name="velocity.log"/>
        <include name="bin/RhythmyxDaemon"/>
        <include name="ConvertDatasources.*"/>
        <include name="DatabaseShutdown.*"/>
        <include name="JRE-32-bak/**"/>
        <include name="JRE-32/**"/>
        <include name="JRE-64/**"/>
        <include name="logs/**"/>
        <include name="sys_resources/**" />
        <!-- Delete any left over translations artifacts -->
        <include name="tobetranslated.tmx"/>
        <include name="PercussionCM.exe"/>
        <include name="PercussionCM.lax"/>
        <include name="PercussionCM.bin.lax"/>
        <include name="netstat.tmp"/>
        <include name="Percussion_DTS_InstallLog.log"/>
        <include name="Percussion_InstallLog.log"/>
        <include name="PercussionCMShutdown.bat"/>
        <include name="PercussionServer.bin"/>
        <include name="PercussionServer.exe"/>
        <!-- Not Deleting PercussionServer.lax, PercussionServer.bin.lax as is used by PSUpdateJettyConfigFromJBoss deleting it there -->
        <include name="server_run_lock"/>
        <include name="shutdown.tmp"/>
        <include name="StartServer.bat"/>
        <include name="StartServer.sh"/>
        <include name="StopServer.bat"/>
        <include name="StopServer.sh"/>
        <include name="Synchronizer.bin"/>
        <include name="Synchronizer.exe"/>
        <include name="Synchronizer.lax"/>
        <include name="sys_search/lucene/indexes/**"/> <!-- Remove old lucene indexes - file format to old -->
        <!--
        <include name="ObjectStore/psx_cerffNavImage.xml"/>
        <include name="ObjectStore/psx_cerffNavon.xml"/>
        <include name="ObjectStore/psx_cerffNavTree.xml"/> -->
      <!--  <include name="ObjectStore/psx_cepercNavImage.xml"/>
        <include name="ObjectStore/psx_cepercNavon.xml"/>
        <include name="ObjectStore/psx_cepercNavTree.xml"/> -->
    </patternset>

    <patternset id="upgrade.overwrite">
        <include name="rxconfig/Server/RequestHandlers.xml"/>
        <include name="rxconfig/Server/ContentEditors/ContentEditorSystemDef.xml"/>
        <include name="rxconfig/Server/startupProcessManager.properties"/>
        <include name="rxconfig/Server/sys_DatabaseFunctionDefs.xml"/>
        <include name="rxconfig/Installer/**"/>
        <include name="sys_resources/**"/>
        <include name="Defaults/**"/>
        <include name="cm/**"/>
        <include name="DTD"/>
        <include name="Packages/Percussion/**"/>
        <include name="jetty/upstream/**"/>
        <include name="jetty/defaults/**"/>
        <include name="jetty/base/webapps/CI_Home.war/**"/>
        <include name="jetty/base/webapps/EI_Home.war/**"/>
        <include name="jetty/base/webapps/Rhythmyx/**"/>
        <include name="jetty/base/webapps/CI_Home.xml"/>
        <include name="jetty/base/webapps/EI_Home.xml"/>
        <include name="jetty/base/webapps/Rhythmyx.xml"/>
        <include name="**/*.bat"/>
        <include name="**/*.sh"/>
    </patternset>

    <patternset id="upgrade.excludes">
        <exclude name="jetty/base/webapps/Rhythmyx/WEB-INF/config/user/**"/>
        <exclude name="jetty/base/etc/perc-ds.properties"/>
        <exclude name="jetty/base/etc/perc-ds.xml"/>
        <exclude name="jetty/base/etc/installation.properties"/>
        <exclude name="jetty/base/resources/log4j*.xml"/>
        <exclude name="rxconfig/Installer/rxrepository.properties"/>
        <exclude name="rx_resources/vm/custom_head.vm"/>
        <exclude name="rx_resources/stylesheets/rx_Templates.xsl"/>
        <exclude name="rx_resources/stylesheets/rx_DisplayFieldTemplates.xsl"/>
        <exclude name="rx_resources/stylesheets/rx_bannerTemplate.xsl"/>
        <exclude name="rx_resources/stylesheets/DefaultError.xsl"/>
        <exclude name="rx_resources/stylesheets/StatusBarQuery.xsl"/>
        <exclude name="rx_resources/stylesheets/searchBox.xsl"/>
        <exclude name="**/customer_config_override.json"/>
        <exclude name="Repository/**"/>
        <exclude name="Extensions/**"/>
        <exclude name="rxconfig/**"/>
        <exclude name="Deployment"/>
        <exclude name="Staging"/>
        <exclude name="logs"/>
        <exclude name="ObjectStore/**"/>
        <exclude name="jetty/base/logs"/>
        <exclude name="rxconfig/Installer/*.bat"/>
        <exclude name="ObjectStore/psx_cerffAutoIndex.xml"/>
        <exclude name="ObjectStore/psx_cerffBrief.xml"/>
        <exclude name="ObjectStore/psx_cerffCalendar.xml"/>
        <exclude name="ObjectStore/psx_cerffContacts.xml"/>
        <exclude name="ObjectStore/psx_cerffEvent.xml"/>
        <exclude name="ObjectStore/psx_cerffExternalLink.xml"/>
        <exclude name="ObjectStore/psx_cerffFile.xml"/>
        <exclude name="ObjectStore/psx_cerffGeneric.xml"/>
        <exclude name="ObjectStore/psx_cerffGenericWord.xml"/>
        <exclude name="ObjectStore/psx_cerffHome.xml"/>
        <exclude name="ObjectStore/psx_cerffImage.xml"/>
        <exclude name="ObjectStore/psx_cerffNavImage.xml"/>
        <exclude name="ObjectStore/psx_cerffPressRelease.xml"/>
        <exclude name="ObjectStore/psx_cepercNavImage.xml"/>
        <exclude name="ObjectStore/psx_cepercNavon.xml"/>
        <exclude name="ObjectStore/psx_cepercNavTree.xml"/>
    </patternset>

    <patternset id="upgrade.preserve">
        <include name="**/**"/>
    </patternset>

    <property name="dir.cache" location="dir.cache"/>

    <target name="clean">
        <if>
            <istrue value="do.clean"/>
            <then>
                <echo>cleaning installation folder ${install.dir}...</echo>
                <delete dir="${install.dir}"/>
            </then>
        </if>
    </target>

    <target name="install" depends="init">

        <if>
            <and>
                <istrue value="${do.install}"/>
                <isfalse value="${do.upgrade}"/>
            </and>
            <then>
                <antcall target="install.chain" inheritall="true" inheritrefs="true"/>
            </then>
        </if>

        <if>
            <and>
                <isfalse value="${do.install}"/>
                <istrue value="${do.upgrade}"/>
            </and>
            <then>
                <antcall target="upgrade.chain" inheritall="true" inheritrefs="true"/>
            </then>
        </if>

        <echo>Installation Complete</echo>

    </target>


    <target name="install.chain">
        <echo>Performing new installation...</echo>

        <antcall target="backup" inheritall="true" inheritrefs="true"/>
        <antcall target="clean" inheritall="true" inheritrefs="true"/>
        <antcall target="install_server" inheritall="true" inheritrefs="true"/>
        <antcall target="configure_jetty" inheritall="true" inheritrefs="true"/>
        <antcall target="setupDB" inheritall="true" inheritrefs="true"/>
        <antcall target="updatePackages" inheritall="true" inheritrefs="true"/>
        <antcall target="updateExtensions" inheritall="true" inheritrefs="true"/>
        <antcall target="alwaysCopyIfMissing" inheritall="true" inheritrefs="true"/>
        <ant antfile="updateConfiguration.xml" target="updateConfiguration" inheritAll="true" inheritRefs="true" />
        <antcall target="updateAuditLog" inheritall="true" inheritrefs="true"/>


    </target>

    <target name="upgrade.chain">
        <echo>Performing upgrade installation...</echo>
        <antcall target="backup" inheritall="true" inheritrefs="true"/>
        <antcall target="backupSharedContent" inheritall="true" inheritrefs="true"/>
        <antcall target="deleteOldLog4jJars"  inheritall="true" inheritrefs="true"/>
        <antcall target="upgrade_server" inheritall="true" inheritrefs="true"/>
        <antcall target="setupDB" inheritall="true" inheritrefs="true"/>
        <antcall target="updatePackages" inheritall="true" inheritrefs="true"/>
        <antcall target="updateAuditLog" inheritall="true" inheritrefs="true"/>
        <antcall target="updateExtensions" inheritall="true" inheritrefs="true"/>
        <ant antfile="removeOldPatches.xml" target="removeOldPatches" inheritAll="true" inheritRefs="true" />
        <antcall target="alwaysCopyIfMissing" inheritall="true" inheritrefs="true"/>
        <ant antfile="updateConfiguration.xml" target="updateConfiguration" inheritAll="true" inheritRefs="true" />
        <antcall target="updateConfigXMLForPasswordFilter" inheritall="true" inheritrefs="true"/>
        <antcall target="upgradeSiteConfig" inheritall="true" inheritrefs="true" />
        <antcall target="replaceOldFontAwesome"  inheritall="true" inheritrefs="true"/>
        <antcall target="deleteOldJqueryUIJsFile"  inheritall="true" inheritrefs="true"/>
        <antcall target="deleteOldJqueryJsFile"  inheritall="true" inheritrefs="true"/>
        <antcall target="deleteOldEXEFiles"  inheritall="true" inheritrefs="true"/>
        <antcall target="deleteOldBouncyCastleJars"  inheritall="true" inheritrefs="true"/>
        <antcall target="backupTinymceRxresources"  inheritall="true" inheritrefs="true"/>
    </target>

    <target name="deleteOldLog4jJars">

        <delete failonerror="false" includeemptydirs="true" verbose="true">
            <fileset dir="${install.dir}/PreInstall/Backups/">
                <include name="**/log4j*.jar"/>
            </fileset>
        </delete>

        <delete failonerror="false" includeemptydirs="true" verbose="true">
            <fileset dir="${install.dir}">
                <include name="**/log4j*.jar"/>
                <exclude name="**/Deployment/**"/>
                <exclude name="**/Staging/**"/>
                <exclude name="**/devtools/**"/>
            </fileset>
        </delete>

    </target>

    <target name="backupSharedContent">
        <if>
            <not>
                <available file="${install.dir}/rxconfig/Server/ContentEditors/shared/rxs_ct_shared.xml_percbak" type="file" />
            </not>
            <then>
                <echo>Backup rxs_ct_shared.xml...</echo>
                <copy file="${install.dir}/rxconfig/Server/ContentEditors/shared/rxs_ct_shared.xml" tofile="${install.dir}/rxconfig/Server/ContentEditors/shared/rxs_ct_shared.xml_percbak" />
            </then>
        </if>
        <echo>Deleting wrong dir from previous install...</echo>
        <delete dir="${install.dir}/rxconfig/ContentEditors" includeemptydirs="true" verbose="true" />
        <echo>Deleting wrongcase(shared/Shared) dir incase not Windows...</echo>
        <if>
            <not>
                <os family="windows" />
            </not>
            <then>
                <delete dir="${install.dir}/rxconfig/Server/ContentEditors/Shared" includeemptydirs="true" verbose="true" />
            </then>
        </if>

    </target>

    <target name="deleteOldBouncyCastleJars">
        <echo>Deleting BouncyCastle Jars...</echo>
        <delete failonerror="false" >
            <fileset dir="${install.dir}/JRE/lib/ext" includes="**/bcprov-*.jar"/>
            <fileset dir="${install.dir}/JRE/lib/ext" includes="**/bctls-*.jar"/>
            <fileset dir="${install.dir}/JRE/lib/ext" includes="**/bcpkix-*.jar"/>
            <fileset dir="${install.dir}/JRE/lib/ext" includes="**/bcmail-*.jar"/>
            <fileset dir="${install.dir}/JRE/lib/ext" includes="**/bcpg-*.jar"/>
            <fileset dir="${install.dir}/JRE64/lib/ext" includes="**/bcprov-*.jar"/>
            <fileset dir="${install.dir}/JRE64/lib/ext" includes="**/bctls-*.jar"/>
            <fileset dir="${install.dir}/JRE64/lib/ext" includes="**/bcpkix-*.jar"/>
            <fileset dir="${install.dir}/JRE64/lib/ext" includes="**/bcmail-*.jar"/>
            <fileset dir="${install.dir}/JRE64/lib/ext" includes="**/bcpg-*.jar"/>
        </delete>
    </target>

    <target name="deleteOldJqueryUIJsFile">
        <if>
            <available file="${install.dir}/web_resources/cm/jslib/jquery-ui.1.12.1.js" type="file" />
            <then>
                <delete file="${install.dir}/web_resources/cm/jslib/jquery-ui.1.12.1.js"/>
            </then>
        </if>
    </target>

    <target name="backupTinymceRxresources">
        <echo>Backup tinymce overrides as needs to be upgraded to 5...</echo>
        <copy todir="${install.dir}/rx_resources/tinymce_811Upgrade_BAK">
            <fileset dir="${install.dir}/rx_resources/tinymce"/>
        </copy>
        <delete failonerror="false" includeemptydirs="true" verbose="true">
            <fileset dir="${install.dir}/rx_resources/tinymce">
                <include name="**/*"/>
                <exclude name="**/customer_config_override.json"/>
            </fileset>
        </delete>
    </target>

    <target name="deleteOldEXEFiles">
        <echo>Deleting old 7.3.2 exe files...</echo>
        <delete>
            <fileset dir="${install.dir}">
                <include name="lax.jar"/>
                <include name="PackageBuilderHelp.zip"/>
                <include name="PackageInstallerHelp.zip"/>
                <include name="PercussionPackageBuilder.*"/>
                <include name="PercussionPackageInstaller.*"/>
                <include name="RhythmyxMultiServerManager.*"/>
                <include name="RhythmyxServer.*"/>
                <include name="RhythmyxServerAdministrator.*"/>
                <include name="RhythmyxServerPropertiesEditor.*"/>
                <include name="RhythmyxWorkbench.*"/>
                <include name="RhythmyxWorkbenchHelp.zip"/>
                <include name="RhythmyxXSpLit.*"/>
            </fileset>
        </delete>
      </target>


    <target name="deleteOldJqueryJsFile">
        <if>
            <available file="${install.dir}/web_resources/widgets/navBar/js/jquery-1.2.6.min.js" type="file" />
            <then>
                <delete file="${install.dir}/web_resources/widgets/navBar/js/jquery-1.2.6.min.js"/>
            </then>
        </if>
        <if>
            <available file="${install.dir}/rx_resources/js/jquery-2.1.4.js" type="file" />
            <then>
                <delete file="${install.dir}/rx_resources/js/jquery-2.1.4.js"/>
            </then>
        </if>
    </target>

    <target name="upgradeSiteConfig">
        <echo>Upgrading Site Configs for Secure Sites...</echo>
        <PSUpgradeSiteConfig rootDir="${install.dir}" />
    </target>

    <target name="replaceOldFontAwesome">
        <if>
        <available file="${install.dir}/web_resources/cm/css/FontAwesome/" type="dir" />
        <then>
            <delete dir="${install.dir}/web_resources/cm/css/FontAwesome/"/>
            <mkdir dir="${install.dir}/web_resources/cm/css/fontawesome/"/>
            <copy todir="${install.dir}/web_resources/cm/css/fontawesome/">
                <fileset dir="${install.src}/jetty/base/webapps/Rhythmyx/cm/jslib/profiles/3x/libraries/fontawesome" includes="**/*" />
            </copy>
        </then>
        </if>
    </target>

    <target name="backup">
        <if>
            <istrue value="${do.backup}"/>
            <then>
                <!--<echo>Backing up to ${backup_folder}</echo>
                 need to maintain customer files -->
                <!--    <copy todir="${backup_folder}" preservelastmodified="true" filtering="false" overwrite="true" force="true" includeEmptyDirs="true">
                        <fileset dir="${install.dir}"/>
                    </copy>-->
                <!--<move file="${install.dir}" tofile="${backup_folder}" preservelastmodified="true"/>-->
            </then>
        </if>
    </target>


    <target name="zip_AppServer">
        <if>
            <available file="${install.dir}/AppServer" type="dir"/>
            <then>
                <echo>Backing up AppServer folder to ${install.dir}/AppServer_backup_${timestamp}.zip</echo>
                <zip destfile="${install.dir}/AppServer_backup_${timestamp}.zip">
                    <fileset dir="${install.dir}/AppServer"/>
                </zip>
            </then>
        </if>
    </target>


    <target name="upgrade_server">
        <echo>Upgrading ${install.dir}...</echo>

        <echo>Cleaning up folders...</echo>
        <delete verbose="true" includeEmptyDirs="true">
            <fileset dir="${install.dir}">
                <patternset refid="upgrade.replace.folders"/>
            </fileset>
        </delete>

        <echo>Deleting files...</echo>
        <delete verbose="true" includeEmptyDirs="true">
            <fileset dir="${install.dir}">
                <patternset refid="upgrade.delete"/>
            </fileset>
        </delete>

        <echo>Removing previously backed up JRE...</echo>
        <delete dir="${install.dir}/JRE_BAK" includeemptydirs="true" failonerror="false" />
        <echo>Backing up JRE to JRE_BAK...</echo>
        <copy todir="${install.dir}/JRE_BAK" overwrite="true" failonerror="false" preservelastmodified="true" >
            <fileset dir="${install.dir}/JRE" followsymlinks="false"/>
        </copy>

        <echo>Copying updated files...</echo>
        <copy verbose="true" todir="${install.dir}"  preservelastmodified="true" filtering="false" overwrite="false" force="true" includeEmptyDirs="true">

            <fileset dir="${install.src}">
                <patternset refid="upgrade.preserve"/>
                <patternset refid="cache.file.excludes"/>
                <patternset refid="upgrade.excludes"/>
                <exclude name="**/Assets.json"/>
                <exclude name="**/Pages.json"/>
            </fileset>
        </copy>

        <echo>Overwrite files</echo>
        <delete verbose="true" includeEmptyDirs="true" performgconfaileddelete="true" failonerror="false">
            <fileset dir="${install.dir}">
                <patternset refid="upgrade.overwrite"/>
                <patternset refid="cache.file.excludes"/>
                <patternset refid="upgrade.excludes"/>
                <exclude name="**/Deployment/**"/>
                <exclude name="**/Staging/**"/>
                <exclude name="TomcatStartup.*"/>
                <exclude name="TomcatShutdown.*"/>
            </fileset>
        </delete>
        <copy verbose="true" todir="${install.dir}" preservelastmodified="true" filtering="false" overwrite="true" force="true" includeEmptyDirs="true">
            <fileset dir="${install.src}">
                <patternset refid="upgrade.overwrite"/>
                <patternset refid="cache.file.excludes"/>
                <patternset refid="upgrade.excludes"/>
                <exclude name="**/Assets.json"/>
                <exclude name="**/Pages.json"/>
            </fileset>

        </copy>

        <echo>Copy any missing files</echo>
        <copy todir="${install.dir}/rxconfig/Installer/data" overwrite="true">
            <fileset dir="${install.src}/rxconfig/Installer/data">
                <include name="**"/>
            </fileset>
        </copy>
        <copy file="${install.src}/Version.properties" tofile="${install.dir}/Version.properties" overwrite="true" failonerror="false" force="true"/>

        <!-- Copy custom_head.vm in upgrade -->
        <copy todir="${install.dir}/rx_resources/vm" overwrite="false" failonerror="false">
            <fileset dir="${install.src}/rx_resources/vm" defaultexcludes="no">
                <present present="srconly" targetdir="${install.dir}/rx_resources/vm"/>
                <include name="custom_head.vm"/>
            </fileset>
         </copy>


        <copy todir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user" overwrite="false" failonerror="false">
            <fileset dir="${install.src}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user/" followsymlinks="false" includes="**">
                <present present="srconly" targetdir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user"/>
            </fileset>
        </copy>
        <!-- Always Force replace of image widget xml config files -->
        <delete verbose="true" failonerror="false" file="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user/spring/imageWidget-beans.xml"/>
        <delete verbose="true" failonerror="false" file="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user/spring/imageWidget-servlet.xml"/>

        <copy verbose="true" todir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user/spring" overwrite="true" failonerror="false">
            <fileset dir="${install.src}/jetty/base/webapps/Rhythmyx/WEB-INF/config/user/spring" followsymlinks="false" includes="imageWidget*.xml">
            </fileset>
        </copy>

        <copy todir="${install.dir}/rxconfig/Installer" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/rxconfig/Installer" followsymlinks="false" includes="rxrepository.properties">
                <present present="srconly" targetdir="${install.dir}/rxconfig/Installer"/>
            </fileset>
        </copy>

        <copy todir="${install.dir}/Repository" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/Repository" followsymlinks="false" includes="**">
                <present present="srconly" targetdir="${install.dir}/Repository"/>
            </fileset>
        </copy>

        <copy todir="${install.dir}/ObjectStore" failonerror="false" overwrite="true">
            <fileset dir="${install.src}/ObjectStore" followsymlinks="false" includes="**">
                <patternset refid="upgrade.excludes"/>
               <!-- <present present="srconly" targetdir="${install.dir}/ObjectStore"/> -->
            </fileset>
        </copy>

        <echo>Adding IMG HASH Mappings for IMG1 and IMG2 </echo>
        <replace summary="yes">
            <fileset dir="${install.dir}/ObjectStore" followsymlinks="false" includes="**">
            <include name="**/*.xml"/>
            <not>
                <contains text="IMG1_HASH" casesensitive="false" />
            </not>
                <and>
                    <contains text="IMG1" casesensitive="false" />
                </and>
            </fileset>

        <replacetoken><![CDATA[<PSXFieldSet name="sharedimage" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">]]></replacetoken>
        <replacevalue><![CDATA[ <PSXFieldSet name="sharedimage" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">
                    <PSXField forceBinary="no" modificationType="user" name="img1_hash" showInPreview="yes" showInSummary="yes" type="shared">
              <DataType></DataType>
              <PSXSearchProperties enableTransformation="no" id="0" tokenizeSearchContent="no" userCustomizable="yes" userSearchable="no" visibleToGlobalQuery="yes"/>
            </PSXField>
                   <PSXField forceBinary="no" modificationType="user" name="img2_hash" showInPreview="yes" showInSummary="yes" type="shared">
              <DataType></DataType>
              <PSXSearchProperties enableTransformation="no" id="0" tokenizeSearchContent="no" userCustomizable="yes" userSearchable="no" visibleToGlobalQuery="yes"/>
            </PSXField>]]></replacevalue>
        <replacefilter>
            <replacetoken><![CDATA[ <PSXDisplayMapping>
               <FieldRef>img1</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="76" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
        ]]></replacetoken>
        <replacevalue><![CDATA[ <PSXDisplayMapping>
               <FieldRef>img1</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="76" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
            <PSXDisplayMapping>
               <FieldRef>img1_hash</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="10003" name="sys_HashedFile"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
            <PSXDisplayMapping>
               <FieldRef>img2_hash</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Mini:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="10005" name="sys_HashedFile"/>
                  <ErrorLabel>
                     <PSXDisplayText>Mini:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>]]></replacevalue>
            </replacefilter>
        </replace>

        <echo> updating sys_TinyMCE and sys_EditLive with sys_tinymce in objectstore </echo>
        <replace dir="${install.dir}/ObjectStore">
            <include name="**/*.xml"/>
            <replacefilter>
                <replacetoken><![CDATA[name="sys_TinyMCE"]]></replacetoken>
                <replacevalue><![CDATA[name="sys_tinymce"]]></replacevalue>
            </replacefilter>
            <replacefilter>
                <replacetoken><![CDATA[name="sys_EditLive"]]></replacetoken>
                <replacevalue><![CDATA[name="sys_tinymce"]]></replacevalue>
            </replacefilter>
        </replace>

        <echo>Adding ITEM_FILE_ATTACHMENT_HASH Mapping </echo>
        <replace summary="yes">
            <fileset dir="${install.dir}/ObjectStore" followsymlinks="false" includes="**">
            <include name="**/*.xml"/>

            <not>
                <contains text="item_file_attachment_hash" />
            </not>
                <and>
                    <contains text="item_file_attachment" />
                </and>
            </fileset>
        <replacefilter>
            <replacetoken><![CDATA[    <PSXDisplayMapping>
              <FieldRef>item_file_attachment</FieldRef>
                        <PSXUISet accessKey="F"/>
            </PSXDisplayMapping>
        ]]></replacetoken>
        <replacevalue><![CDATA[    <PSXDisplayMapping>
              <FieldRef>item_file_attachment</FieldRef>
                        <PSXUISet accessKey="F"/>
            </PSXDisplayMapping>
              <PSXDisplayMapping>
              <FieldRef>item_file_attachment_hash</FieldRef>
                        <PSXUISet accessKey="H"/>
            </PSXDisplayMapping>]]></replacevalue>
            </replacefilter>
        </replace>

        <echo> updating sys_TinyMCE and sys_EditLive with sys_tinymce in rxs_ct_shared and new columns </echo>
        <replace dir="${install.dir}/rxconfig/Server/ContentEditors/shared">
            <include name="**/*.xml"/>
            <replacefilter>
                <replacetoken><![CDATA[name="sys_TinyMCE"]]></replacetoken>
                <replacevalue><![CDATA[name="sys_tinymce"]]></replacevalue>
            </replacefilter>
            <replacefilter>
                <replacetoken><![CDATA[name="sys_EditLive"]]></replacetoken>
                <replacevalue><![CDATA[name="sys_tinymce"]]></replacevalue>
            </replacefilter>
        </replace>

        <echo>Adding IMG HASH Mappings for IMG1 and IMG2 in rxs_ct_shared</echo>
        <replace summary="yes">
            <fileset  dir="${install.dir}/rxconfig/Server/ContentEditors/shared" followsymlinks="false" includes="**">
            <include name="**/*.xml"/>

            <not>
                <contains text="IMG1_HASH" />
            </not>
            </fileset>
            <replacetoken><![CDATA[<PSXFieldSet name="sharedimage" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">]]></replacetoken>
            <replacevalue><![CDATA[<PSXFieldSet name="sharedimage" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">
        <PSXField forceBinary="no" modificationType="user" name="img1_hash" showInPreview="yes" showInSummary="yes" type="shared">
            <DataLocator>
               <PSXBackEndColumn id="0">
                  <tableAlias>RXS_CT_SHAREDIMAGE</tableAlias>
                  <column>IMG1_HASH</column>
                  <columnAlias/>
               </PSXBackEndColumn>
            </DataLocator>
            <DataType>text</DataType>
            <DataFormat>10</DataFormat>
            <OccurrenceSettings delimiter=";" dimension="optional" multiValuedType="delimited"/>
            <PSXPropertySet>
               <PSXProperty locked="yes" name="cleanupBrokenInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
               <PSXProperty locked="yes" name="mayHaveInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
            </PSXPropertySet>
            <PSXSearchProperties enableTransformation="no" id="0" tokenizeSearchContent="no" userCustomizable="yes" userSearchable="yes" visibleToGlobalQuery="yes"/>
         </PSXField>
        <PSXField forceBinary="no" modificationType="user" name="img2_hash" showInPreview="yes" showInSummary="yes" type="shared">
            <DataLocator>
               <PSXBackEndColumn id="0">
                  <tableAlias>RXS_CT_SHAREDIMAGE</tableAlias>
                  <column>IMG2_HASH</column>
                  <columnAlias/>
               </PSXBackEndColumn>
            </DataLocator>
            <DataType>text</DataType>
            <DataFormat>10</DataFormat>
            <OccurrenceSettings delimiter=";" dimension="optional" multiValuedType="delimited"/>
            <PSXPropertySet>
               <PSXProperty locked="yes" name="cleanupBrokenInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
               <PSXProperty locked="yes" name="mayHaveInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
            </PSXPropertySet>
            <PSXSearchProperties enableTransformation="no" id="0" tokenizeSearchContent="no" userCustomizable="yes" userSearchable="yes" visibleToGlobalQuery="yes"/>
         </PSXField>]]></replacevalue>
        <replacefilter>
            <replacetoken><![CDATA[ <PSXDisplayMapping>
               <FieldRef>img1</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="76" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
        ]]></replacetoken>
        <replacevalue><![CDATA[ <PSXDisplayMapping>
               <FieldRef>img1</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="76" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
            <PSXDisplayMapping>
               <FieldRef>img1_hash</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="10003" name="sys_HashedFile"/>
                  <ErrorLabel>
                     <PSXDisplayText>Image:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
            <PSXDisplayMapping>
               <FieldRef>img2_hash</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>Mini:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="10005" name="sys_HashedFile"/>
                  <ErrorLabel>
                     <PSXDisplayText>Mini:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>]]></replacevalue>
            </replacefilter>
        </replace>

        <echo>Adding ITEM_FILE_ATTACHMENT_HASH Mapping </echo>
        <replace summary="yes">
            <fileset  dir="${install.dir}/rxconfig/Server/ContentEditors/shared" followsymlinks="false" includes="**">
            <include name="**/*.xml"/>

            <not>
                <contains text="ITEM_FILE_ATTACHMENT_HASH" />
            </not>
            </fileset>
            <replacetoken><![CDATA[<PSXFieldSet name="sharedbinary" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">]]></replacetoken>
            <replacevalue><![CDATA[<PSXFieldSet name="sharedbinary" repeatability="oneOrMore" supportsSequencing="no" type="multiPropertySimpleChild" userSearchable="yes">
        <PSXField forceBinary="no" modificationType="user" name="item_file_attachment_hash" showInPreview="yes" showInSummary="yes" type="shared">
            <DataLocator>
               <PSXBackEndColumn id="0">
                  <tableAlias>RXS_CT_SHAREDBINARY</tableAlias>
                  <column>ITEM_FILE_ATTACHMENT_HASH</column>
                  <columnAlias/>
               </PSXBackEndColumn>
            </DataLocator>
            <DataType>text</DataType>
            <DataFormat>10</DataFormat>
            <OccurrenceSettings delimiter=";" dimension="optional" multiValuedType="delimited"/>
            <PSXPropertySet>
               <PSXProperty locked="yes" name="cleanupBrokenInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
               <PSXProperty locked="yes" name="mayHaveInlineLinks">
                  <Value type="Boolean">no</Value>
               </PSXProperty>
            </PSXPropertySet>
            <PSXSearchProperties enableTransformation="no" id="0" tokenizeSearchContent="no" userCustomizable="yes" userSearchable="yes" visibleToGlobalQuery="yes"/>
         </PSXField>]]></replacevalue>
        <replacefilter>
            <replacetoken><![CDATA[   <PSXDisplayMapping>
               <FieldRef>item_file_attachment</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="121" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
        ]]></replacetoken>
        <replacevalue><![CDATA[   <PSXDisplayMapping>
               <FieldRef>item_file_attachment</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="121" name="sys_File"/>
                  <ErrorLabel>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>
             <PSXDisplayMapping>
               <FieldRef>item_file_attachment_hash</FieldRef>
               <PSXUISet>
                  <Label>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </Label>
                  <PSXControlRef id="10005" name="sys_HashedFile"/>
                  <ErrorLabel>
                     <PSXDisplayText>File:</PSXDisplayText>
                  </ErrorLabel>
               </PSXUISet>
            </PSXDisplayMapping>]]></replacevalue>
            </replacefilter>
        </replace>

        <copy todir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/spring/projects" overwrite="false" failonerror="false">
            <fileset dir="${install.src}/jetty/base/webapps/Rhythmyx/WEB-INF/config/spring/projects" followsymlinks="false" includes="**">
                <present present="srconly" targetdir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/spring/projects"/>
            </fileset>
        </copy>

       <copy todir="${install.dir}/jetty/base/logs" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/jetty/base/webapps/Rhythmyx/WEB-INF/config/spring/projects" followsymlinks="false" includes="**">
                <present present="srconly" targetdir="${install.dir}/jetty/base/webapps/Rhythmyx/WEB-INF/config/spring/projects"/>
            </fileset>
        </copy>

        <copy todir="${install.dir}/jetty/base/start.d" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/jetty/defaults/start.d" followsymlinks="false" includes="jvm.ini">
                <present present="srconly" targetdir="${install.dir}/jetty/base/start.d"/>
            </fileset>
        </copy>



        <copy todir="${install.dir}/jetty/base/resources" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/jetty/base/resources" followsymlinks="false" includes="log4j*.xml">
                <present present="srconly" targetdir="${install.dir}/jetty/base/resources"/>
            </fileset>
        </copy>

        <antcall target="zip_AppServer" inheritall="true" inheritrefs="true" />

        <echo>Updating rxrepository.properties</echo>
        <chmod perm="ugo+rw" file="${install.dir}/jetty/base/etc/perc-ds.properties" />
        <touch mkdirs="true" file="${install.dir}/jetty/base/etc/perc-ds.properties"/>

        <echo>loading properties ${rxrepository.properties}</echo>
        <loadproperties>
            <file file="${rxrepository.properties}"/>
        </loadproperties>

        <echoproperties/>

        <antcall target="configure_jetty" inheritall="true" inheritrefs="true" />

        <copy todir="${install.dir}/jetty/base/etc/" overwrite="false" failonerror="false">
            <fileset dir="${install.src}/jetty/base/etc/" followsymlinks="false" includes="perc-ds.*,installation.properties">
                <present present="srconly" targetdir="${install.dir}/jetty/base/etc/"/>
            </fileset>
        </copy>

        <echo>Remove DOCTYPE from perc-ds.xml..</echo>
        <if>
            <available file="${install.dir}/jetty/base/etc/perc-ds.xml"/>
            <then>
                <if>
                    <istrue value="${upgradeFrom732}"/>
                    <then>
                        <echo>Replace perc-ds.xml with new version from source </echo>
                        <copy file="${install.src}/jetty/base/etc/perc-ds.xml" tofile="${install.dir}/jetty/base/etc/perc-ds.xml" />
                    </then>
                    <else>
                        <if>
                            <resourcecontains resource="${install.dir}/jetty/base/etc/perc-ds.xml" substring="DOCTYPE Configure PUBLIC " />

                            <then>
                                <echo>Removing Doctype from ${install.dir}/jetty/base/etc/perc-ds.xml </echo>
                                <replace file="${install.dir}/jetty/base/etc/perc-ds.xml" summary="yes">
                                    <replacetoken><![CDATA[<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_3.dtd">]]></replacetoken>
                                    <replacevalue><![CDATA[]]></replacevalue>
                                </replace>
                            </then>
                        </if>
                        <if>
                            <resourcecontains resource="${install.dir}/jetty/base/etc/perc-ds.xml" substring="com.percussion.utils.container.jetty.PSJettyUtils" />
                            <then>
                                <echo>Replacing PSJettyUtils with PSStaticContainerUtils from ${install.dir}/jetty/base/etc/perc-ds.xml </echo>
                                <replace file="${install.dir}/jetty/base/etc/perc-ds.xml" summary="yes">
                                    <replacetoken><![CDATA[com.percussion.utils.container.jetty.PSJettyUtils]]></replacetoken>
                                    <replacevalue><![CDATA[com.percussion.utils.container.PSStaticContainerUtils]]></replacevalue>
                                </replace>
                            </then>
                        </if>
                    </else>
                </if>
            </then>
        </if>
        <if>
            <available file="${install.dir}/jetty/defaults/etc/perc-ds.xml"/>
            <then>
                <if>
                    <!--- if ugrading from 7.3.2, then this file will be there thus replace with new -->
                    <resourcecontains resource="${install.dir}/jetty/defaults/etc/perc-ds.xml" substring="com.percussion.utils.container.jetty.PSJettyUtils" />
                <then>
                    <echo>Replace perc-ds.xml with new version from source </echo>
                    <copy file="${install.src}/jetty/defaults/etc/perc-ds.xml" tofile="${install.dir}/jetty/defaults/etc/perc-ds.xml" />
                </then>
                <else>
                    <if>
                    <resourcecontains resource="${install.dir}/jetty/defaults/etc/perc-ds.xml" substring="DOCTYPE Configure PUBLIC " />

                        <then>
                            <echo>Removing Doctype from ${install.dir}/jetty/defaults/etc/perc-ds.xml </echo>
                            <replace file="${install.dir}/jetty/defaults/etc/perc-ds.xml" summary="yes">
                                <replacetoken><![CDATA[<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_3.dtd">]]></replacetoken>
                                <replacevalue><![CDATA[]]></replacevalue>
                            </replace>
                        </then>
                    </if>
                    <if>
                        <resourcecontains resource="${install.dir}/jetty/base/etc/perc-ds.xml" substring="com.percussion.utils.container.jetty.PSJettyUtils" />
                        <then>
                            <echo>Replacing PSJettyUtils with PSStaticContainerUtils from ${install.dir}/jetty/base/etc/perc-ds.xml </echo>
                            <replace file="${install.dir}/jetty/base/etc/perc-ds.xml" summary="yes">
                                <replacetoken><![CDATA[com.percussion.utils.container.jetty.PSJettyUtils]]></replacetoken>
                                <replacevalue><![CDATA[com.percussion.utils.container.PSStaticContainerUtils]]></replacevalue>
                            </replace>
                        </then>
                    </if>
                    </else>
                </if>
            </then>
        </if>
        <if>
            <available file="${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml"/>
            <then>
                <if>
                    <!--- if ugrading from 7.3.2, then this file will be there thus replace with new -->
                    <resourcecontains resource="${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml" substring="com.percussion.utils.container.jetty.PSJettyUtils" />
                <then>
                    <echo>Replace perc-ds.xml with new version from source </echo>
                    <copy file="${install.src}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml" tofile="${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml" />
                </then>
                <else>
                <if>
                    <resourcecontains resource="${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml" substring="!DOCTYPE Configure" />
                    <then>
                        <echo>Removing Doctype from ${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml </echo>
                        <replace file="${install.dir}/jetty/defaults/modules/perc-ds/etc/perc-ds.xml" summary="yes">
                            <replacetoken><![CDATA[<!DOCTYPE Configure
  PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_3.dtd">]]></replacetoken>
                            <replacevalue><![CDATA[]]></replacevalue>
                        </replace>
                    </then>
                </if>
                    <if>
                        <resourcecontains resource="${install.dir}/jetty/base/etc/perc-ds.xml" substring="com.percussion.utils.container.jetty.PSJettyUtils" />
                        <then>
                            <echo>Replacing PSJettyUtils with PSStaticContainerUtils from ${install.dir}/jetty/base/etc/perc-ds.xml </echo>
                            <replace file="${install.dir}/jetty/base/etc/perc-ds.xml" summary="yes">
                                <replacetoken><![CDATA[com.percussion.utils.container.jetty.PSJettyUtils]]></replacetoken>
                                <replacevalue><![CDATA[com.percussion.utils.container.PSStaticContainerUtils]]></replacevalue>
                            </replace>
                        </then>
                    </if>
                </else>
                </if>
            </then>
        </if>

        <echo>Creating jetty work and logs directory..</echo>
        <mkdir dir="${install.dir}/jetty/base/work"/>
        <mkdir dir="${install.dir}/jetty/base/logs"/>

        <if>
            <isset property="${isWindows}"/>
            <then>
                <echo>Windows install detected, setting compatibility mode for phantomjs.exe...</echo>
                <exec executable="reg.exe">
                    <arg value="Add"/>
                    <arg value="&quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers&quot;"/>
                    <arg value="/v"/>
                    <arg value="&quot;${install.dir}/bin/phantomjs.exe&quot;"/>
                    <arg value="/d"/>
                    <arg value="&quot;WIN7RTM&quot;"/>
                </exec>
            </then>
        </if>

        <echo>Fixing Line Feeds...</echo>
        <fixcrlf srcdir="${install.dir}"  preservelastmodified="true">
            <patternset refid="text.files"/>
            <exclude name="**/Deployment/**"/>
            <exclude name="**/Staging/**"/>
        </fixcrlf>

        <if>
            <isset property="${isMac}" />
            <then>
                <echo>Skipping setting executable permissions on osx</echo>
            </then>
            <else>
                <echo>Setting executable Permissions</echo>
                <chmod perm="o+x" failifexecutionfails="false" failonerror="false" includes="**/*.sh" dir="${install.dir}"/>
            </else>
        </if>

        <if>
            <available file="${install.dir}/AppServer/server/rx/deploy/jboss-web.deployer/server.xml" type="file"/>
            <then>
                <copy file="${install.dir}/AppServer/server/rx/deploy/jboss-web.deployer/server.xml" tofile="${install.dir}/JBossServerXML_BAK/server.xml" />
            </then>
        </if>

        <copy todir="${install.dir}/jetty/base/etc/" overwrite="false" failonerror="false" flatten="true">
            <fileset dir="${install.dir}/AppServer" casesensitive="false">
                <include name="**/*.keystore"/>
                <type type="file"/>
            </fileset>
        </copy>

        <copy todir="${install.dir}/rxconfig/trusted_certificates/" overwrite="false" failonerror="false" flatten="true">
            <fileset dir="${install.dir}/AppServer" casesensitive="false">
                <include name="**/*.cert"/>
                <include name="**/*.cer"/>
                <include name="**/*.crt"/>
                <include name="**/*.pem"/>
                <include name="**/*.key"/>
                <type type="file"/>
            </fileset>
        </copy>
        <delete dir="${install.dir}/AppServer" verbose="true" failonerror="false" />
        <delete dir="${install.dir}/jetty/base/webapps/RxServices"/>
        <delete dir="${install.dir}/jetty/base/webapps/root"/>
    </target>


    <target name="install_server">
        <echo>Install to ${install.dir}</echo>
        <mkdir dir="${install.dir}"/>
        <echo>Copying ${install.src} to ${install.dir}</echo>
        <copy todir="${install.dir}" preservelastmodified="true" filtering="false" overwrite="true" force="true" includeEmptyDirs="true">

            <fileset dir="${install.src}">
                <patternset refid="cache.file.excludes"/>
                <!-- Exclude Fast Forward Content Types Definitions
                     must be installed with packages instead.-->
                <exclude name="psx_cerff*.xml"/>
                <exclude name="**/Assets.json"/>
                <exclude name="**/Pages.json"/>
            </fileset>
        </copy>

        <echo>Fixing Line Feeds</echo>
        <fixcrlf srcdir="${install.dir}" preservelastmodified="true">
            <patternset refid="text.files"/>
            <exclude name="**/Deployment/**"/>
            <exclude name="**/Staging/**"/>
        </fixcrlf>

        <if>
            <isset property="${isMac}" />
            <then>
                <echo>Setting property file Permissions...</echo>
                <chmod perm="ugo+rw" maxparallel="300">
                    <fileset dir="${install.dir}/rx_resources">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/web_resources">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/rxconfig">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/ObjectStore">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/jetty/base">
                        <include name="**/*" />
                    </fileset>
                </chmod>
                <echo>Setting executable Permissions</echo>
                <chmod maxparallel="300" perm="ugo+x" failifexecutionfails="false" failonerror="false" includes="**/*.sh" dir="${install.dir}"/>
            </then>
            <else>
                <echo>Setting executable Permissions</echo>
                <chmod perm="ugo+x" failifexecutionfails="false" failonerror="false" includes="**/*.sh" dir="${install.dir}"/>
                <echo>Setting property file Permissions...</echo>
                <chmod perm="ugo+rw">
                    <fileset dir="${install.dir}/rx_resources">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/web_resources">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/rxconfig">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/ObjectStore">
                        <include name="**/*" />
                    </fileset>
                    <fileset dir="${install.dir}/jetty/base">
                        <include name="**/*" />
                    </fileset>
                </chmod>
            </else>
        </if>
    </target>

    <target name="create_checksum">
        <mkdir dir="${dir.cache}"/>
        <for param="file">
            <path>
                <fileset dir="${install.src}/." />
            </path>
            <sequential>
                <local name="md5" />
                <local name="relativeFile" />

                <checksum file="@{file}" algorithm="md5" format="MD5SUM" property="md5"/>
                <property name="relativeFile" location="@{file}" basedir="${dist}" relative="true" />
                <echo file="checksums.md5" append="true">${md5} *${relativeFile}
                </echo>
            </sequential>
        </for>
    </target>

    <target name="updatePackages">
        <echo>Updating system packages...</echo>
        <!-- Always replace InstallPackages.xml -->
        <delete file="${install.dir}/rxconfig/Installer/InstallPackages.xml" failonerror="false" verbose="true" />
        <if>
            <istrue value="${do.upgrade}"/>
            <then>
                <copy verbose="true" overwrite="true" file="${install.src}/rxconfig/Installer/InstallPackages.upgrade.xml" tofile="${install.dir}/rxconfig/Installer/InstallPackages.xml" />
                <if>
                    <istrue value="${upgradeFrom732}"/>
                    <then>
                        <echo>Adding Workflow Package to 7.3.2 upgrade...</echo>
                        <replace file="${install.dir}/rxconfig/Installer/InstallPackages.xml" summary="yes">
                            <replacetoken><![CDATA[<PackageFileList>]]></replacetoken>
                            <replacevalue><![CDATA[<PackageFileList>
    <PackageFileEntry>
        <packageName>perc.workflow</packageName>
        <status>PENDING</status>
    </PackageFileEntry>]]></replacevalue>
                        </replace>
                    </then>
                </if>

            </then>
            <else>
                <copy verbose="true" overwrite="true" file="${install.src}/rxconfig/Installer/InstallPackages.xml" tofile="${install.dir}/rxconfig/Installer/InstallPackages.xml" />
            </else>
        </if>

    </target>

    <target name="updateAuditLog">
        <echo>Updating Audit Log Property file ...</echo>
        <delete file="${install.dir}/rxconfig/Server/audit-log.properties" failonerror="false" verbose="true" />
        <copy verbose="true" overwrite="true" file="${install.src}/rxconfig/Installer/audit-log.properties" tofile="${install.dir}/rxconfig/Server/audit-log.properties" />

        <propertyfile file="${install.dir}/rxconfig/Server/audit-log.properties">
            <entry key="filePath" value="${install.dir}/jetty/base/logs"/>
        </propertyfile>
        <delete file="${install.dir}/rxconfig/Installer/audit-log.properties" failonerror="false" verbose="true" />

    </target>

    <target name="updateConfigXMLForPasswordFilter">
        <echo>Updating Server Config.xml ...</echo>
        <if>
            <available file="${install.dir}/rxconfig/Server/config.xml"/>
            <then>
                <if>
                    <not>
                        <resourcecontains resource="${install.dir}/rxconfig/Server/config.xml" substring="passwordFilter" />
                    </not>
                    <then>
                        <echo>Adding passwordFilter </echo>
                        <replace file="${install.dir}/rxconfig/Server/config.xml" summary="yes">
                            <replacetoken><![CDATA[<passwordColumn>PASSWORD</passwordColumn>]]></replacetoken>
                            <replacevalue><![CDATA[<passwordColumn>PASSWORD</passwordColumn>
                                <passwordFilter>Java/global/percussion/filter/sys_DefaultPasswordFilter</passwordFilter>]]></replacevalue>
                        </replace>
                    </then>
                </if>
            </then>
        </if>

    </target>

    <target name="updateExtensions">
        <echo>Updating updateExtensions ...</echo>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-main-${project.parent.version}.jar" destDir="Exits"/>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-workflow-${project.parent.version}.jar" destDir="WorkflowExits"/>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-sfp-${project.parent.version}.jar" destDir="SiteFolderPublishinExits"/>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-nav-${project.parent.version}.jar" destDir="ManagedNavExits"/>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-default-template-${project.parent.version}.jar" destDir="DefaultTemplateExits"/>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/extensions-linkback-${project.parent.version}.jar" destDir="LinkbackExits"/>
        <if>
            <available file="${install.dir}/LinkbackExits/install-files.xml"/>
            <then>
                <ant antfile="${install.dir}/LinkbackExits/install-files.xml" inheritall="true"/>
            </then>
        </if>
        <PSInstallExtensions extensionJar="${extensions.jar.path}/perc-toolkit-${project.parent.version}.jar" destDir="PercToolkitExits"/>
        <if>
            <available file="${install.dir}/PercToolkitExits/install-files.xml"/>
            <then>
                <ant antfile="${install.dir}/PercToolkitExits/install-files.xml" inheritall="true"/>
            </then>
        </if>
    </target>

    <!--==========================================================-->
    <!-- PSInstallExtensions                                      -->
    <!--                                                          -->
    <!-- Copies source extension files from srcDir to destDir,    -->
    <!-- then installs/updates the extensions.  Note that destDir -->
    <!-- is assumed to be relative to the Rhythmyx root directory -->
    <!-- and extXml is the Extensions.xml source file for this    -->
    <!-- group of extensions.  In REFRESH mode, extensions        -->
    <!-- will only be updated if necessary.                       -->
    <!--==========================================================-->
    <macrodef name="PSInstallExtensions">
        <attribute name="extensionJar" default=""/>
        <attribute name="destDir" default=""/>
        <sequential>

            <if>
                <isset property="REFRESH"/>
                <then>
                    <uptodate property="EXTS.ARE.UPTODATE" targetfile="${install.dir}/Extensions/@{destDir}-ext.xml" srcfile="@{extXml}" />
                </then>
            </if>
            <if>
                <not>
                    <isset property="EXTS.ARE.UPTODATE"/>
                </not>
                <then>
                    <mkdir dir="${install.dir}/Extensions"/>

                    <mkdir dir="${install.dir}/@{destDir}"/>
                    <unzip src="@{extensionJar}" dest="${install.dir}/@{destDir}">
                        <patternset>
                            <exclude name="**/META-INF" />
                        </patternset>
                    </unzip>
                    <echo>Updating Add-On Extensions...</echo>
                    <copy file="${install.dir}/@{destDir}/Extensions.xml" tofile="${install.dir}/Extensions/@{destDir}-ext.xml"/>
                    <PSExtensions installLocation="@{destDir}" />
                </then>
                <else>
                    <echo>@{destDir} extensions are up to date, skipping...</echo>
                </else>
            </if>


        </sequential>
    </macrodef>

    <target name="alwaysCopyIfMissing">
        <mkdir dir="${install.dir}/rxconfig/velocity"/>
        <copy todir="${install.dir}/rxconfig/velocity">
            <fileset dir="${install.src}/rxconfig/velocity" includes="**/*" />
        </copy>
        <copy todir="${install.dir}/rxconfig/Server">
            <fileset dir="${install.src}/rxconfig/velocity/2.2/config" includes="**/*.properties" />
        </copy>
        <mkdir dir="${install.dir}/rxconfig/ssh-keys" />
        <touch file="${install.dir}/rxconfig/ssh-keys/config" />
        <mkdir dir="${install.dir}/rxconfig/trusted_certificates" />
        <echo>Refreshing web_resources themes...</echo>
        <copy todir="${install.dir}/web_resources/themes" failonerror="false" overwrite="false">
            <fileset dir="${install.src}/web_resources/themes" followsymlinks="false" includes="**">
                <present present="srconly" targetdir="${install.dir}/web_resources/themes"/>
            </fileset>
        </copy>
        <echo>Deleting misplaced files....</echo>
        <delete dir="${install.dir}/jetty/base/webapps/Rhythmyx/cm/WEB-INF" verbose="true" includeEmptyDirs="true" performgconfaileddelete="true" failonerror="false"/>
    </target>

</project>
